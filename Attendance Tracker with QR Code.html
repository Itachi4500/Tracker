<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracker with QR Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <!-- QR Code Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <!-- Markdown Parser for Gemini Response -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .status-badge, .btn-action, .modal-overlay {
            transition: all 0.3s ease-in-out;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #report-content h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        #report-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, getDocs, serverTimestamp, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const clockDisplay = document.getElementById('clock-display');
        const dateDisplay = document.getElementById('date-display');
        const statusBadge = document.getElementById('status-badge');
        const statusText = document.getElementById('status-text');
        const clockInBtn = document.getElementById('clock-in-btn');
        const startBreakBtn = document.getElementById('start-break-btn');
        const endBreakBtn = document.getElementById('end-break-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const summaryClockIn = document.getElementById('summary-clock-in');
        const summaryTotalBreak = document.getElementById('summary-total-break');
        const summaryTotalHours = document.getElementById('summary-total-hours');
        const historyTableBody = document.getElementById('history-table-body');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingOverlay = document.getElementById('loading-overlay');
        const qrModal = document.getElementById('qr-modal');
        const qrCanvas = document.getElementById('qr-canvas');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const qrMessage = document.getElementById('qr-message');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportModal = document.getElementById('report-modal');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');
        const reportContent = document.getElementById('report-content');
        const reportLoading = document.getElementById('report-loading');

        // --- STATE VARIABLES ---
        let db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentState = { status: 'clockedOut', clockInTime: null, clockOutTime: null, totalBreakDuration: 0, breaks: [] };
        let todayDocId = new Date().toISOString().slice(0, 10);
        let todayDocUnsubscribe = null;
        let qrTimer = null;

        // --- FIREBASE SETUP ---
        async function setupFirebase() {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "your-fallback-api-key", authDomain: "...", projectId: "..." };
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, inMemoryPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        loadingOverlay.classList.add('hidden');
                        await initializeAppLogic();
                    } else {
                        isAuthReady = false;
                        loadingOverlay.classList.remove('hidden');
                        userIdDisplay.textContent = 'Not authenticated';
                    }
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingOverlay.textContent = 'Error loading application. Please refresh.';
            }
        }
        
        // --- APPLICATION LOGIC ---
        async function initializeAppLogic() {
            if (!isAuthReady || !userId) return;
            if (todayDocUnsubscribe) todayDocUnsubscribe();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const todayDocRef = doc(db, `artifacts/${appId}/users/${userId}/attendance`, todayDocId);

            todayDocUnsubscribe = onSnapshot(todayDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentState = {
                        status: data.status || 'clockedOut',
                        clockInTime: data.clockInTime?.toDate(),
                        clockOutTime: data.clockOutTime?.toDate(),
                        totalBreakDuration: data.totalBreakDuration || 0,
                        breaks: data.breaks || [],
                    };
                } else {
                    resetDailyState();
                }
                updateUI();
            });
            await renderHistory();
        }

        function resetDailyState() {
            currentState = { status: 'clockedOut', clockInTime: null, clockOutTime: null, totalBreakDuration: 0, breaks: [] };
        }

        // --- UI & TIME FUNCTIONS ---
        function updateClock() {
            const now = new Date();
            clockDisplay.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            dateDisplay.textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (currentState.status === 'clockedIn' || currentState.status === 'onBreak') updateSummary();
        }

        function updateUI() {
            updateStatusBadge();
            updateActionButtons();
            updateSummary();
            lucide.createIcons();
        }

        function updateStatusBadge() {
            statusBadge.classList.remove('bg-gray-500', 'bg-green-500', 'bg-yellow-500');
            switch (currentState.status) {
                case 'clockedIn': statusText.textContent = 'Clocked In'; statusBadge.classList.add('bg-green-500'); break;
                case 'onBreak': statusText.textContent = 'On Break'; statusBadge.classList.add('bg-yellow-500'); break;
                default: statusText.textContent = 'Clocked Out'; statusBadge.classList.add('bg-gray-500'); break;
            }
        }

        function updateActionButtons() {
            clockInBtn.classList.toggle('hidden', currentState.status !== 'clockedOut');
            startBreakBtn.classList.toggle('hidden', currentState.status !== 'clockedIn');
            endBreakBtn.classList.toggle('hidden', currentState.status !== 'onBreak');
            clockOutBtn.classList.toggle('hidden', currentState.status === 'clockedOut' || currentState.status === 'onBreak');
        }

        function updateSummary() {
            summaryClockIn.textContent = currentState.clockInTime ? currentState.clockInTime.toLocaleTimeString() : '--:--:--';
            summaryTotalBreak.textContent = formatDuration(currentState.totalBreakDuration);
            if (currentState.clockInTime) {
                const endTime = currentState.clockOutTime || new Date();
                const totalElapsed = endTime - currentState.clockInTime;
                let totalWorkMs = totalElapsed - currentState.totalBreakDuration;
                if (currentState.status === 'onBreak') {
                    const lastBreak = currentState.breaks[currentState.breaks.length - 1];
                    if (lastBreak && !lastBreak.endTime) totalWorkMs -= (new Date() - lastBreak.startTime.toDate());
                }
                summaryTotalHours.textContent = formatDuration(Math.max(0, totalWorkMs));
            } else {
                summaryTotalHours.textContent = '0h 0m 0s';
            }
        }

        function formatDuration(ms) {
            if (ms < 0) ms = 0;
            const s = Math.floor(ms / 1000);
            return `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m ${s%60}s`;
        }

        async function renderHistory() {
            if (!isAuthReady || !userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/attendance`);
            const q = query(historyCollectionRef);
            try {
                const querySnapshot = await getDocs(q);
                let historyHtml = '';
                const docs = [];
                querySnapshot.forEach(doc => docs.push(doc.data()));
                docs.sort((a, b) => new Date(b.date) - new Date(a.date));
                docs.forEach(data => {
                    const clockIn = data.clockInTime ? data.clockInTime.toDate().toLocaleTimeString() : 'N/A';
                    const clockOut = data.clockOutTime ? data.clockOutTime.toDate().toLocaleTimeString() : 'N/A';
                    const breakDur = formatDuration(data.totalBreakDuration || 0);
                    let totalHours = 'N/A';
                    if (data.clockInTime && data.clockOutTime) {
                        totalHours = formatDuration(data.clockOutTime.toDate() - data.clockInTime.toDate() - (data.totalBreakDuration || 0));
                    }
                    historyHtml += `<tr class="border-b border-gray-200"><td class="py-3 px-4">${data.date}</td><td class="py-3 px-4">${clockIn}</td><td class="py-3 px-4">${clockOut}</td><td class="py-3 px-4">${breakDur}</td><td class="py-3 px-4 font-medium">${totalHours}</td></tr>`;
                });
                historyTableBody.innerHTML = historyHtml || '<tr><td colspan="5" class="text-center py-4">No attendance history found.</td></tr>';
            } catch (error) {
                console.error("Error fetching history:", error);
                historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Could not load history.</td></tr>';
            }
        }

        // --- QR CODE MODAL ---
        function showQrCodeModal(action) {
            if (!isAuthReady || !userId) return;
            const payload = { userId, action, timestamp: Date.now() };
            new QRious({ element: qrCanvas, value: JSON.stringify(payload), size: 256, padding: 16, level: 'H', foreground: '#1f2937', background: '#ffffff' });
            qrMessage.textContent = `Present this QR code to the scanner to ${action.replace('-', ' ')}.`;
            qrModal.classList.remove('hidden');
            qrTimer = setTimeout(() => {
                qrMessage.textContent = 'Scan successful! Logging your time...';
                if (action === 'clock-in') handleClockIn();
                else if (action === 'clock-out') handleClockOut();
                setTimeout(hideQrCodeModal, 1500);
            }, 3000);
        }

        function hideQrCodeModal() {
            if (qrTimer) clearTimeout(qrTimer);
            qrModal.classList.add('hidden');
        }

        // --- EVENT HANDLERS ---
        async function handleClockIn() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/attendance`, todayDocId);
            try { await setDoc(docRef, { date: todayDocId, clockInTime: serverTimestamp(), status: 'clockedIn', totalBreakDuration: 0, breaks: [] }); await renderHistory(); }
            catch (error) { console.error("Error clocking in:", error); }
        }
        async function handleStartBreak() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/attendance`, todayDocId);
            const updatedBreaks = [...currentState.breaks, { startTime: Timestamp.now(), endTime: null }];
            try { await updateDoc(docRef, { status: 'onBreak', breaks: updatedBreaks }); }
            catch (error) { console.error("Error starting break:", error); }
        }
        async function handleEndBreak() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/attendance`, todayDocId);
            const updatedBreaks = [...currentState.breaks];
            if (updatedBreaks.length > 0) updatedBreaks[updatedBreaks.length - 1].endTime = Timestamp.now();
            const newTotalBreakDuration = updatedBreaks.reduce((total, br) => total + (br.endTime ? br.endTime.toMillis() - br.startTime.toMillis() : 0), 0);
            try { await updateDoc(docRef, { status: 'clockedIn', breaks: updatedBreaks, totalBreakDuration: newTotalBreakDuration }); }
            catch (error) { console.error("Error ending break:", error); }
        }
        async function handleClockOut() {
            if (currentState.status === 'onBreak') { alert("Please end your break before clocking out."); return; }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/attendance`, todayDocId);
            try { await updateDoc(docRef, { status: 'clockedOut', clockOutTime: serverTimestamp() }); setTimeout(renderHistory, 1000); }
            catch (error) { console.error("Error clocking out:", error); }
        }

        // --- GEMINI API FEATURE ---
        async function handleGenerateReport() {
            if (!isAuthReady || !userId) return;

            reportContent.innerHTML = '';
            reportLoading.classList.remove('hidden');
            reportModal.classList.remove('hidden');

            try {
                // 1. Fetch last 7 days of data
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const sevenDaysAgoStr = sevenDaysAgo.toISOString().slice(0, 10);

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const historyCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/attendance`);
                const q = query(historyCollectionRef, where("date", ">=", sevenDaysAgoStr));
                
                const querySnapshot = await getDocs(q);
                const weeklyData = [];
                querySnapshot.forEach(doc => weeklyData.push(doc.data()));

                if (weeklyData.length === 0) {
                    reportContent.innerHTML = '<p>No data found for the last 7 days to generate a report.</p>';
                    reportLoading.classList.add('hidden');
                    return;
                }

                // 2. Format data for the prompt
                let promptData = "Here is the employee's work data for the last 7 days:\n";
                weeklyData.sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort chronologically
                weeklyData.forEach(data => {
                    if (data.clockInTime && data.clockOutTime) {
                        const totalHours = formatDuration(data.clockOutTime.toDate() - data.clockInTime.toDate() - (data.totalBreakDuration || 0));
                        promptData += `- Date: ${data.date}, Clock In: ${data.clockInTime.toDate().toLocaleTimeString()}, Clock Out: ${data.clockOutTime.toDate().toLocaleTimeString()}, Total Hours: ${totalHours}\n`;
                    }
                });

                const prompt = `You are a helpful HR assistant. Analyze the following weekly work data and provide a brief, encouraging summary for the employee. Include the total hours worked for the week and one or two insightful comments on their work pattern (like consistency, long days, etc.). Present the result in simple Markdown. \n\n${promptData}`;

                // 3. Call Gemini API
                const apiKey = ""; // API key will be injected by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const reportText = result.candidates[0].content.parts[0].text;
                
                // 4. Display the report
                reportContent.innerHTML = marked.parse(reportText);

            } catch (error) {
                console.error("Error generating report:", error);
                reportContent.innerHTML = `<p class="text-red-500">Sorry, we couldn't generate the report at this time. Please try again later.</p>`;
            } finally {
                reportLoading.classList.add('hidden');
            }
        }

        // --- INITIALIZATION ---
        clockInBtn.addEventListener('click', () => showQrCodeModal('clock-in'));
        clockOutBtn.addEventListener('click', () => showQrCodeModal('clock-out'));
        startBreakBtn.addEventListener('click', handleStartBreak);
        endBreakBtn.addEventListener('click', handleEndBreak);
        closeModalBtn.addEventListener('click', hideQrCodeModal);
        generateReportBtn.addEventListener('click', handleGenerateReport);
        closeReportModalBtn.addEventListener('click', () => reportModal.classList.add('hidden'));

        setInterval(updateClock, 1000);
        updateClock();
        setupFirebase();
        lucide.createIcons();
    </script>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl relative">
        <div id="loading-overlay" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50">
            <div class="text-center"><svg class="animate-spin h-8 w-8 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-2 text-lg font-medium text-gray-700">Initializing...</p></div>
        </div>
        <header class="text-center mb-8"><h1 class="text-4xl font-bold text-gray-800">Attendance Tracker</h1><p id="user-id-display" class="text-sm text-gray-500 mt-2">Initializing...</p></header>
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8">
                <div class="text-center md:text-left mb-4 md:mb-0"><p id="clock-display" class="text-5xl font-bold text-blue-600">12:00:00 PM</p><p id="date-display" class="text-lg text-gray-500">Friday, August 1, 2025</p></div>
                <div id="status-badge" class="status-badge flex items-center justify-center py-2 px-6 rounded-full text-white font-bold text-lg"><span id="status-text">Clocked Out</span></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <button id="clock-in-btn" class="btn-action w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-lg flex items-center justify-center text-lg shadow-md"><i data-lucide="qr-code" class="mr-2"></i> Clock In</button>
                <button id="start-break-btn" class="btn-action w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-lg flex items-center justify-center text-lg shadow-md hidden"><i data-lucide="coffee" class="mr-2"></i> Start Break</button>
                <button id="end-break-btn" class="btn-action w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-lg flex items-center justify-center text-lg shadow-md hidden"><i data-lucide="play-circle" class="mr-2"></i> End Break</button>
                <button id="clock-out-btn" class="btn-action w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-lg flex items-center justify-center text-lg shadow-md hidden"><i data-lucide="qr-code" class="mr-2"></i> Clock Out</button>
            </div>
            <div class="bg-gray-50 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Today's Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div><p class="text-sm text-gray-500">Clocked In At</p><p id="summary-clock-in" class="text-2xl font-semibold text-gray-800">--:--:--</p></div>
                    <div><p class="text-sm text-gray-500">Total Break</p><p id="summary-total-break" class="text-2xl font-semibold text-gray-800">0h 0m 0s</p></div>
                    <div><p class="text-sm text-gray-500">Total Hours</p><p id="summary-total-hours" class="text-2xl font-semibold text-green-600">0h 0m 0s</p></div>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-700">Attendance History</h2>
                <button id="generate-report-btn" class="btn-action bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center text-sm shadow-md">
                    <i data-lucide="sparkles" class="mr-2 h-4 w-4"></i> Generate Weekly Report
                </button>
            </div>
            <div class="overflow-x-auto"><table class="w-full text-left">
                <thead><tr class="bg-gray-100 text-gray-600 uppercase text-sm"><th class="py-3 px-4 rounded-l-lg">Date</th><th class="py-3 px-4">Clock In</th><th class="py-3 px-4">Clock Out</th><th class="py-3 px-4">Break</th><th class="py-3 px-4 rounded-r-lg">Total Hours</th></tr></thead>
                <tbody id="history-table-body" class="text-gray-700"></tbody>
            </table></div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qr-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 text-center max-w-sm w-full mx-4"><h2 class="text-2xl font-bold mb-4 text-gray-800">Scan QR Code</h2><canvas id="qr-canvas" class="mx-auto border-4 border-gray-200 rounded-lg"></canvas><p id="qr-message" class="mt-4 text-gray-600 min-h-[40px]"></p><button id="close-modal-btn" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancel</button></div>
    </div>

    <!-- Weekly Report Modal -->
    <div id="report-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Your Weekly Report</h2>
                <button id="close-report-modal-btn" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div id="report-loading" class="text-center hidden">
                <svg class="animate-spin h-8 w-8 text-purple-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                <p class="mt-2 text-lg font-medium text-gray-700">✨ Generating your report with Gemini...</p>
            </div>
            <div id="report-content" class="prose max-w-none text-gray-700"></div>
        </div>
    </div>
    
    <script>
      lucide.createIcons();
    </script>
</body>
</html>
