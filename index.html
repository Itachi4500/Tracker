<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Attendance System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        #reader { width: 100%; max-width: 500px; margin: 0 auto; border: 2px dashed #d1d5db; border-radius: 8px; }
        .qr-code { width: 100%; max-width: 200px; height: auto; }
        .birthday-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .dark-mode { background-color: #1a202c; color: #f7fafc; }
        .dark-mode .card, .dark-mode .modal-content { background-color: #2d3748; }
        .dark-mode .tab-btn { color: #9ca3af; }
        .dark-mode .tab-btn.active { color: #818cf8; border-color: #818cf8; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; }
        .toast { padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; margin-bottom: 0.5rem; opacity: 0; transform: translateX(100%); transition: all 0.5s ease-in-out; }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-indigo-600">Advanced QR Attendance</h1>
                <p class="text-gray-600">Real-time scanning and reporting solution</p>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg id="theme-icon-light" class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 text-gray-100 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </header>
        
        <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-btn active px-4 py-2 font-medium border-b-2 border-indigo-600 text-indigo-600" data-tab="dashboard">Dashboard</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-indigo-600" data-tab="scan">Scan QR</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-indigo-600" data-tab="reports">Reports</button>
            <button class="tab-btn px-4 py-2 font-medium text-gray-500 hover:text-indigo-600" data-tab="employees">Employees</button>
        </div>
        
        <div id="dashboard" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="card bg-white rounded-lg shadow p-6"><h2 class="text-xl font-semibold mb-2">Total Employees</h2><p class="text-4xl font-bold text-indigo-600" id="total-employees">0</p></div>
                <div class="card bg-white rounded-lg shadow p-6"><h2 class="text-xl font-semibold mb-2">Present Today</h2><p class="text-4xl font-bold text-green-600" id="present-today">0</p></div>
                <div class="card bg-white rounded-lg shadow p-6"><h2 class="text-xl font-semibold mb-2">Late Comers</h2><p class="text-4xl font-bold text-amber-600" id="late-comers">0</p></div>
                <div class="card bg-white rounded-lg shadow p-6"><h2 class="text-xl font-semibold mb-2">Avg Hours</h2><p class="text-4xl font-bold text-blue-600" id="avg-hours">0</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 card bg-white rounded-lg shadow p-6"><h2 class="text-xl font-semibold mb-4">Today's Attendance</h2><div class="overflow-x-auto"><table class="min-w-full"><thead><tr class="border-b"><th class="text-left py-2 px-3">Name</th><th class="text-left py-2 px-3">Status</th><th class="text-left py-2 px-3">Time In</th><th class="text-left py-2 px-3">Time Out</th></tr></thead><tbody id="today-attendance"></tbody></table></div></div>
                <div class="card bg-white rounded-lg shadow p-6"><h2 class="text-xl font-semibold mb-4">Upcoming Birthdays</h2><div id="birthdays-list"></div></div>
            </div>
        </div>
        
        <div id="scan" class="tab-content hidden">
            <div class="card bg-white rounded-lg shadow p-6 max-w-2xl mx-auto">
                <h2 class="text-2xl font-semibold mb-4 text-center">Scan Employee QR Code</h2>
                <div id="reader"></div>
                <div id="scan-result" class="text-center mt-4 text-lg font-medium"></div>
            </div>
        </div>
        
        <div id="reports" class="tab-content hidden">
            <div class="card bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Generate Report</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Employee</label><select id="report-employee" class="w-full p-2 border rounded bg-white"><option value="all">All Employees</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label><input type="date" id="start-date" class="w-full p-2 border rounded"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">End Date</label><input type="date" id="end-date" class="w-full p-2 border rounded"></div>
                </div>
                <button id="generate-report" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Generate</button>
                <div id="report-results" class="mt-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Report Chart: Hours Worked</h3>
                    <div class="mb-6"><canvas id="report-chart"></canvas></div>
                    <div class="flex justify-between items-center mb-2"><h3 class="text-lg font-semibold">Report Data</h3><button id="export-csv" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">Export as CSV</button></div>
                    <div class="overflow-x-auto"><table class="min-w-full"><thead><tr class="border-b"><th class="text-left py-2">Date</th><th class="text-left py-2">Employee</th><th class="text-left py-2">Check-in</th><th class="text-left py-2">Check-out</th><th class="text-left py-2">Hours Worked</th></tr></thead><tbody id="report-table"></tbody></table></div>
                </div>
            </div>
        </div>
        
        <div id="employees" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Employee Management</h2><button id="add-employee-btn" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Add Employee</button></div>
            <div class="card bg-white rounded-lg shadow p-6"><div class="overflow-x-auto"><table class="min-w-full"><thead><tr class="border-b"><th class="text-left py-2">Name</th><th class="text-left py-2">Position</th><th class="text-left py-2">Department</th><th class="text-left py-2">QR Code</th><th class="text-left py-2">Actions</th></tr></thead><tbody id="employee-list"></tbody></table></div></div>
        </div>
    </div>
    
    <div id="employee-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white rounded-lg p-8 w-full max-w-md shadow-xl"><h2 class="text-2xl font-semibold mb-6" id="modal-title">Add New Employee</h2><form id="employee-form"><input type="hidden" id="employee-id"><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label><input type="text" id="employee-name" class="w-full p-2 border rounded" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Position</label><input type="text" id="employee-position" class="w-full p-2 border rounded" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Department</label><input type="text" id="employee-dept" class="w-full p-2 border rounded" required></div><div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label><input type="date" id="employee-dob" class="w-full p-2 border rounded" required></div><div class="flex justify-end gap-4 mt-6"><button type="button" id="cancel-employee" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Cancel</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Save Employee</button></div></form></div>
    </div>
    <div id="qr-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white rounded-lg p-6 w-full max-w-sm text-center"><h2 class="text-xl font-semibold mb-4">Employee QR Code</h2><div id="employee-qr-code" class="mx-auto mb-4 p-4 border rounded-lg inline-block"></div><p id="qr-employee-name" class="font-medium text-lg"></p><p id="qr-employee-id" class="text-sm text-gray-600 mb-4"></p><button id="download-qr" class="w-full bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 mb-2">Download QR</button><button id="close-qr" class="w-full bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Close</button></div>
    </div>
    <div id="toast-container"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION ---
    const API_BASE_URL = 'http://localhost:3000/api';
    const LATE_CHECK_IN_TIME = '09:30';

    // --- DOM ELEMENT SELECTORS ---
    const tabContents = document.querySelectorAll('.tab-content');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const employeeList = document.getElementById('employee-list');
    const employeeForm = document.getElementById('employee-form');
    const addEmployeeBtn = document.getElementById('add-employee-btn');
    const employeeModal = document.getElementById('employee-modal');
    const qrModal = document.getElementById('qr-modal');
    const todayAttendance = document.getElementById('today-attendance');
    const birthdaysList = document.getElementById('birthdays-list');
    const reportTable = document.getElementById('report-table');
    const reportEmployeeSelect = document.getElementById('report-employee');
    const generateReportBtn = document.getElementById('generate-report');
    const exportCsvBtn = document.getElementById('export-csv');
    const reportResults = document.getElementById('report-results');
    const themeToggle = document.getElementById('theme-toggle');
    const totalEmployeesEl = document.getElementById('total-employees');
    const presentTodayEl = document.getElementById('present-today');
    const lateComersEl = document.getElementById('late-comers');
    const avgHoursEl = document.getElementById('avg-hours');
    const scanResult = document.getElementById('scan-result');
    const modalTitle = document.getElementById('modal-title');
    const employeeIdInput = document.getElementById('employee-id');

    // --- GLOBAL VARIABLES ---
    let html5QrCode;
    let reportChart;
    let currentEmployees = []; // Cache for employee data
    let currentTheme = localStorage.getItem('theme') || 'light';

    // --- UTILITY & HELPER FUNCTIONS ---

    const showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    };

    const calculateHoursWorked = (record) => {
        if (!record.checkIn || !record.checkOut) return 'N/A';
        // Dates are not relevant here, only the time difference
        const checkIn = new Date(`1970-01-01T${record.checkIn}:00`);
        const checkOut = new Date(`1970-01-01T${record.checkOut}:00`);
        const diff = checkOut - checkIn;
        return (diff / (1000 * 60 * 60)).toFixed(1);
    };

    const generateQrCodeSvg = (employeeId) => {
        const qr = qrcode(0, 'L');
        qr.addData(JSON.stringify({ employeeId }));
        qr.make();
        return qr.createSvgTag(4);
    };

    // --- CORE API FUNCTIONS ---

    const fetchEmployees = async () => {
        try {
            const response = await fetch(`${API_BASE_URL}/employees`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            currentEmployees = await response.json();
            return true;
        } catch (error) {
            console.error("Could not fetch employees:", error);
            showToast('Error: Could not connect to the server.', 'error');
            return false;
        }
    };

    // --- DATA RENDERING & UI LOGIC ---

    const refreshAllData = async () => {
        const success = await fetchEmployees();
        if (success) {
            renderEmployeeTable();
            renderDashboard();
            populateEmployeeSelect();
        }
    };

    const renderEmployeeTable = () => {
        employeeList.innerHTML = '';
        currentEmployees.forEach(employee => {
            const tr = document.createElement('tr');
            tr.className = 'border-b';
            tr.innerHTML = `
                <td class="py-3 px-2">${employee.name}</td>
                <td class="py-3 px-2">${employee.position}</td>
                <td class="py-3 px-2">${employee.department}</td>
                <td class="py-3 px-2"><button class="view-qr text-indigo-600 hover:underline" data-id="${employee.id}">View</button></td>
                <td class="py-3 px-2 flex gap-4">
                    <button class="edit-employee text-blue-600 hover:underline" data-id="${employee.id}">Edit</button>
                    <button class="delete-employee text-red-600 hover:underline" data-id="${employee.id}">Delete</button>
                </td>
            `;
            employeeList.appendChild(tr);
        });
    };

    const renderDashboard = () => {
        const today = new Date().toISOString().split('T')[0];
        
        totalEmployeesEl.textContent = currentEmployees.length;

        const presentEmployees = currentEmployees.filter(emp => emp.attendance.some(rec => rec.date === today && rec.checkIn));
        presentTodayEl.textContent = presentEmployees.length;

        const lateComers = presentEmployees.filter(emp => {
            const todayRecord = emp.attendance.find(rec => rec.date === today);
            return todayRecord && todayRecord.checkIn > LATE_CHECK_IN_TIME;
        }).length;
        lateComersEl.textContent = lateComers;

        const totalHours = presentEmployees.reduce((acc, emp) => {
            const todayRecord = emp.attendance.find(rec => rec.date === today);
            if (todayRecord && todayRecord.checkOut) {
                return acc + parseFloat(calculateHoursWorked(todayRecord));
            }
            return acc;
        }, 0);
        const checkedOutCount = presentEmployees.filter(e => e.attendance.find(r => r.date === today && r.checkOut)).length;
        avgHoursEl.textContent = (checkedOutCount > 0 ? (totalHours / checkedOutCount) : 0).toFixed(1);

        todayAttendance.innerHTML = '';
        presentEmployees.forEach(employee => {
            const todayRecord = employee.attendance.find(record => record.date === today);
            if (todayRecord) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="py-2 px-3">${employee.name}</td>
                    <td class="py-2 px-3"><span class="text-green-600 font-semibold">Present</span></td>
                    <td class="py-2 px-3">${todayRecord.checkIn} ${todayRecord.checkIn > LATE_CHECK_IN_TIME ? '<span class="text-xs text-amber-600 font-bold ml-1">LATE</span>' : ''}</td>
                    <td class="py-2 px-3">${todayRecord.checkOut || 'Not signed out'}</td>
                `;
                todayAttendance.appendChild(tr);
            }
        });

        birthdaysList.innerHTML = '';
        const upcomingBirthdays = currentEmployees.filter(emp => {
            const dob = new Date(emp.dob);
            const now = new Date();
            // Check for birthdays in the current month on or after today
            return dob.getUTCMonth() === now.getUTCMonth() && dob.getUTCDate() >= now.getUTCDate();
        }).sort((a, b) => new Date(a.dob).getUTCDate() - new Date(b.dob).getUTCDate());
        
        if (upcomingBirthdays.length === 0) {
            birthdaysList.innerHTML = '<p class="text-gray-500">No upcoming birthdays this month.</p>';
        } else {
            upcomingBirthdays.forEach(emp => {
                const dob = new Date(emp.dob);
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between py-2 border-b';
                div.innerHTML = `
                    <div><p class="font-medium">${emp.name}</p><p class="text-sm text-gray-600">${emp.department}</p></div>
                    <span class="birthday-badge bg-pink-100 text-pink-800 px-2 py-1 rounded-full text-xs font-semibold">${dob.getUTCDate()} ${dob.toLocaleString('default', { month: 'short' })}</span>
                `;
                birthdaysList.appendChild(div);
            });
        }
    };

    const populateEmployeeSelect = () => {
        reportEmployeeSelect.innerHTML = '<option value="all">All Employees</option>';
        currentEmployees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id;
            option.textContent = emp.name;
            reportEmployeeSelect.appendChild(option);
        });
    };

    // --- MODAL & FORM HANDLING ---

    const openEmployeeModal = (mode = 'add', employeeId = null) => {
        employeeForm.reset();
        if (mode === 'edit') {
            const employee = currentEmployees.find(e => e.id === employeeId);
            if (!employee) return;
            modalTitle.textContent = 'Edit Employee';
            employeeIdInput.value = employee.id;
            document.getElementById('employee-name').value = employee.name;
            document.getElementById('employee-position').value = employee.position;
            document.getElementById('employee-dept').value = employee.department;
            document.getElementById('employee-dob').value = new Date(employee.dob).toISOString().split('T')[0];
        } else {
            modalTitle.textContent = 'Add New Employee';
            employeeIdInput.value = '';
        }
        employeeModal.classList.remove('hidden');
    };

    const closeEmployeeModal = () => employeeModal.classList.add('hidden');

    const handleEmployeeFormSubmit = async (e) => {
        e.preventDefault();
        const id = employeeIdInput.value;
        const employeeData = {
            name: document.getElementById('employee-name').value,
            position: document.getElementById('employee-position').value,
            department: document.getElementById('employee-dept').value,
            dob: document.getElementById('employee-dob').value,
        };

        let url = `${API_BASE_URL}/employees`;
        let method = 'POST';

        if (id) { // Edit Mode
            url = `${API_BASE_URL}/employees/${id}`;
            method = 'PUT';
        } else { // Add Mode
            employeeData.id = 'emp' + Date.now().toString(36);
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(employeeData)
            });
            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.message || 'Server returned an error.');
            }
            showToast(`Employee ${id ? 'updated' : 'added'} successfully!`, 'success');
            await refreshAllData();
            closeEmployeeModal();
        } catch (error) {
            showToast(`Error: ${error.message}`, 'error');
        }
    };

    const handleDeleteEmployee = async (e) => {
        if (!e.target.classList.contains('delete-employee')) return;
        const id = e.target.getAttribute('data-id');
        const employee = currentEmployees.find(emp => emp.id === id);
        
        if (confirm(`Are you sure you want to delete ${employee.name}? This will also delete all their attendance records.`)) {
            try {
                const response = await fetch(`${API_BASE_URL}/employees/${id}`, { method: 'DELETE' });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || 'Server returned an error.');
                }
                showToast('Employee deleted.', 'info');
                await refreshAllData();
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
    };

    const handleEditEmployee = (e) => {
        if (!e.target.classList.contains('edit-employee')) return;
        openEmployeeModal('edit', e.target.getAttribute('data-id'));
    };

    const showQRCodeModal = (e) => {
        if (!e.target.classList.contains('view-qr')) return;
        const id = e.target.getAttribute('data-id');
        const employee = currentEmployees.find(emp => emp.id === id);
        
        if (employee) {
            document.getElementById('employee-qr-code').innerHTML = generateQrCodeSvg(employee.id);
            document.getElementById('qr-employee-name').textContent = employee.name;
            document.getElementById('qr-employee-id').textContent = `ID: ${employee.id}`;
            qrModal.classList.remove('hidden');
            
            document.getElementById('download-qr').onclick = () => {
                const svg = document.querySelector('#employee-qr-code svg');
                let source = new XMLSerializer().serializeToString(svg);
                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
                const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
                const link = document.createElement('a');
                link.download = `${employee.name.replace(/ /g, '_')}_QR.svg`;
                link.href = url;
                link.click();
            };
        }
    };

    // --- SCANNER FUNCTIONS ---

    const onScanSuccess = async (decodedText) => {
        try {
            const data = JSON.parse(decodedText);
            if (!data.employeeId) {
                showToast('Invalid QR Code: No employee ID found.', 'error');
                return;
            }

            const employee = currentEmployees.find(e => e.id === data.employeeId);
            if (!employee) {
                showToast(`Employee with ID ${data.employeeId} not found.`, 'error');
                return;
            }

            const response = await fetch(`${API_BASE_URL}/attendance/${data.employeeId}`, { method: 'POST' });
            if (!response.ok) throw new Error('Server error during attendance update');
            
            const result = await response.json();
            showToast(`${result.message}: ${employee.name}`, result.message === 'Checked In' ? 'success' : 'info');
            
            await refreshAllData(); // Refresh all data to reflect the change
            
        } catch (err) {
            showToast('Failed to process QR code. Ensure it is a valid employee code.', 'error');
            console.error("QR Scan Error:", err);
        }
    };

    const onScanFailure = (error) => { /* Optional: handle scan failure */ };
    
    const startScanner = () => {
        if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        
        // Prevent starting if already scanning
        if (html5QrCode.isScanning) return;

        scanResult.innerHTML = 'Starting camera...';
        html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            scanResult.innerHTML = `<span class="text-red-500">Could not start scanner. Please grant camera permissions.</span>`;
        });
    };

    const stopScanner = () => {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Failed to stop scanner.", err));
        }
    };

    // --- REPORTING FUNCTIONS ---

    const generateReport = () => {
        const employeeId = reportEmployeeSelect.value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            showToast('Please select both a start and end date.', 'error');
            return;
        }
        
        reportTable.innerHTML = '';
        const reportData = [];

        currentEmployees.forEach(emp => {
            if (employeeId !== 'all' && emp.id !== employeeId) return;
            emp.attendance.forEach(record => {
                if (record.date >= startDate && record.date <= endDate) {
                    reportData.push({ ...record, employeeName: emp.name });
                }
            });
        });

        reportData.sort((a,b) => new Date(a.date) - new Date(b.date));

        if (reportData.length === 0) {
            reportTable.innerHTML = '<tr><td colspan="5" class="text-center py-4">No data found for the selected criteria.</td></tr>';
        } else {
            reportData.forEach(data => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="py-2">${data.date}</td>
                    <td class="py-2">${data.employeeName}</td>
                    <td class="py-2">${data.checkIn || 'N/A'}</td>
                    <td class="py-2">${data.checkOut || 'N/A'}</td>
                    <td class="py-2">${calculateHoursWorked(data)}</td>
                `;
                reportTable.appendChild(tr);
            });
        }
        
        renderReportChart(reportData, employeeId === 'all');
        reportResults.classList.remove('hidden');
    };

    const renderReportChart = (reportData, isAllEmployees) => {
        const ctx = document.getElementById('report-chart').getContext('2d');
        const chartData = {};

        if (isAllEmployees) { // Aggregate hours by date for all employees
            reportData.forEach(rec => {
                const hours = parseFloat(calculateHoursWorked(rec));
                if (!isNaN(hours)) chartData[rec.date] = (chartData[rec.date] || 0) + hours;
            });
        } else { // Show hours per day for a single employee
            reportData.forEach(rec => {
                const hours = parseFloat(calculateHoursWorked(rec));
                chartData[rec.date] = isNaN(hours) ? 0 : hours;
            });
        }

        const labels = Object.keys(chartData).sort();
        const dataPoints = labels.map(label => chartData[label]);

        if (reportChart) reportChart.destroy();

        reportChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: isAllEmployees ? 'Total Hours Worked by All' : 'Hours Worked',
                    data: dataPoints,
                    backgroundColor: 'rgba(79, 70, 229, 0.7)',
                    borderColor: 'rgba(79, 70, 229, 1)',
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    };

    const exportToCSV = () => {
        const headers = Array.from(document.querySelectorAll('#report-table th')).map(th => th.textContent);
        const rows = Array.from(document.querySelectorAll('#report-table tr'));
        if (rows.length === 0 || rows[0].children[0].colSpan === 5) {
            showToast('No data to export.', 'info');
            return;
        }
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\r\n";
        
        rows.forEach(row => {
            const cols = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent}"`);
            csvContent += cols.join(",") + "\r\n";
        });
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `attendance_report_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // --- THEME SWITCHER ---
    const applyTheme = (theme) => {
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');
        if (theme === 'dark') {
            document.body.classList.add('dark-mode');
            lightIcon.classList.add('hidden');
            darkIcon.classList.remove('hidden');
        } else {
            document.body.classList.remove('dark-mode');
            lightIcon.classList.remove('hidden');
            darkIcon.classList.add('hidden');
        }
        currentTheme = theme;
        localStorage.setItem('theme', theme);
    };

    // --- EVENT LISTENERS ---
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            stopScanner(); // Always stop scanner when switching tabs
            const tabId = button.getAttribute('data-tab');
            
            tabButtons.forEach(btn => btn.classList.remove('active', 'border-indigo-600', 'text-indigo-600'));
            button.classList.add('active', 'border-indigo-600', 'text-indigo-600');
            
            tabContents.forEach(content => content.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            
            if (tabId === 'scan') startScanner();
        });
    });

    addEmployeeBtn.addEventListener('click', () => openEmployeeModal('add'));
    document.getElementById('cancel-employee').addEventListener('click', closeEmployeeModal);
    document.getElementById('close-qr').addEventListener('click', () => qrModal.classList.add('hidden'));
    employeeForm.addEventListener('submit', handleEmployeeFormSubmit);
    employeeList.addEventListener('click', (e) => {
        handleDeleteEmployee(e);
        handleEditEmployee(e);
        showQRCodeModal(e);
    });
    generateReportBtn.addEventListener('click', generateReport);
    exportCsvBtn.addEventListener('click', exportToCSV);
    themeToggle.addEventListener('click', () => applyTheme(currentTheme === 'dark' ? 'light' : 'dark'));

    // --- INITIALIZATION ---
    applyTheme(currentTheme);
    refreshAllData();
});
</script>
</body>
</html>
